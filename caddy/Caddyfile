{
	order rate_limit before reverse_proxy
}

{$DOMAIN}, www.{$DOMAIN} {
	log {
		output file /var/log/caddy/access.log {
			roll_size 10MiB
			roll_keep 10
		}
		format json
	}

	header {
		Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		X-Frame-Options "DENY"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "accelerometer=(), autoplay=(), camera=(), display-capture=(), encrypted-media=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), midi=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), usb=(), web-share=()"
		Content-Security-Policy-Report-Only "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; form-action 'self'; img-src 'self' data: blob: https:; font-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.matomo.cloud; connect-src 'self' https://matrix.{$DOMAIN} wss:;"

		-Server
	}

	# Matrix client discovery
	@matrix_well_known {
		path /.well-known/matrix/client
	}
	handle @matrix_well_known {
		header Content-Type application/json
		header Access-Control-Allow-Origin *
		respond `{"m.homeserver":{"base_url":"https://matrix.{$DOMAIN}"}}` 200
	}

	# Canonicalize app root paths (add trailing slash)
	@app_roots {
		path /api-stress-test /ichiro-family-tree /shortly /ichiro-walks /portainer /grafana /htmx-demo /wordle-duel-service /wordle-duel
	}
	handle @app_roots {
		redir {path}/ 308
	}

	# Allowed paths
	@allowed {
		path / /index.html /favicon.ico
		path /assets/* /static/* /icons/* /locales/*
		path /robots.txt /sitemap.xml /manifest.json /site.webmanifest
		path /apple-touch-icon*.png /.well-known/acme-challenge/*
		path /.well-known/matrix/client
		path /api-stress-test/* /ichiro-family-tree/* /shortly/* /ichiro-walks/* /portainer/* /grafana/* /htmx-demo/* /wordle-duel-service/* /wordle-duel/*
	}

	# Allowed → rate limit, then route to the right upstream
	handle @allowed {
		rate_limit {
			# Global limit
			zone per_ip_global {
				key {remote_host}
				events 200
				window 10s
			}

			# App paths (stricter)
			zone per_ip_app {
				match {
					path /api-stress-test/* /ichiro-family-tree/* /shortly/* /ichiro-walks/* /htmx-demo/* /wordle-duel-service/* /wordle-duel/*
				}
				key {remote_host}
				events 100
				window 10s
			}
		}

		reverse_proxy gateway:8080
	}

	# Everything else → 404
	handle {
		header X-Unknown-Path "1"
		respond 404
	}
}

matrix.{$DOMAIN} {
	log {
		output file /var/log/caddy/matrix-access.log {
			roll_size 10MiB
			roll_keep 10
		}
		format json
	}

	header {
		Strict-Transport-Security "max-age=63072000"
		X-Frame-Options "DENY"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	# Matrix client discovery on matrix.$DOMAIN
	@matrix_well_known {
		path /.well-known/matrix/client
	}
	handle @matrix_well_known {
		header Content-Type application/json
		header Access-Control-Allow-Origin *
		respond `{"m.homeserver":{"base_url":"https://matrix.{$DOMAIN}"}}` 200
	}

	# rate limit only client traffic
	@matrix_client {
		path /_matrix/client/*
	}
	handle @matrix_client {
		rate_limit {
			zone per_ip_matrix_client {
				key {remote_host}
				events 300
				window 10s
			}
		}
		reverse_proxy conduit:6167
	}

	# all other Matrix APIs, no rate limit
	@matrix_other {
		path /_matrix/*
		path / /favicon.ico
	}
	handle @matrix_other {
		reverse_proxy conduit:6167
	}

	# everything else gets dropped before touching Conduit
	handle {
		header X-Unknown-Path "1"
		respond 404
	}
}
