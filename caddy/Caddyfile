{
	order rate_limit before reverse_proxy
}

{$DOMAIN}, www.{$DOMAIN} {
	log {
		output file /var/log/caddy/access.log {
			roll_size 10MiB
			roll_keep 10
		}
		format json
	}

	header {
		Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		X-Frame-Options "DENY"
		X-Content-Type-Options "nosniff"
		-Server
	}

	# Matrix client discovery
	@matrix_well_known {
		path /.well-known/matrix/client
	}
	handle @matrix_well_known {
		header Content-Type application/json
		header Access-Control-Allow-Origin *
		respond `{"m.homeserver":{"base_url":"https://matrix.{$DOMAIN}"}}` 200
	}

	# Allowed paths
	@allowed {
		path / /index.html /favicon.ico
		path /assets/* /static/* /icons/* /locales/*
		path /robots.txt /sitemap.xml /manifest.json /site.webmanifest
		path /apple-touch-icon*.png /.well-known/acme-challenge/*
		path /.well-known/matrix/client
		path /api-stress-test/* /ichiro-family-tree/* /shortly/* /ichiro-walks/* /portainer/* /grafana/* /htmx-demo/*
	}

	# Allowed → rate limit, then route to the right upstream
	handle @allowed {
		rate_limit {
			# Global limit
			zone per_ip_global {
				key {remote_host}
				events 200
				window 10s
			}

			# App paths (stricter)
			zone per_ip_app {
				match {
					path /api-stress-test/* /ichiro-family-tree/* /shortly/* /ichiro-walks/* /htmx-demo/*
				}
				key {remote_host}
				events 100
				window 10s
			}
		}

		reverse_proxy gateway:8080
	}

	# Everything else → 404
	handle {
		header X-Unknown-Path "1"
		respond 404
	}
}

matrix.{$DOMAIN} {
	reverse_proxy conduit:6167
}